<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEC Forensic Filing Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e17;--bg2:#111827;--bg3:#1a2235;--bg4:#243049;
  --tx:#e2e8f0;--tx2:#94a3b8;--tx3:#64748b;
  --green:#22c55e;--green2:#16a34a;--green-bg:rgba(34,197,94,.08);
  --red:#ef4444;--red2:#dc2626;--red-bg:rgba(239,68,68,.08);
  --blue:#3b82f6;--blue2:#2563eb;--blue-bg:rgba(59,130,246,.08);
  --amber:#f59e0b;--amber-bg:rgba(245,158,11,.08);
  --cyan:#06b6d4;
  --border:#1e293b;--border2:#334155;
  --radius:8px;
}
html{font-size:14px}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',sans-serif;line-height:1.6;min-height:100vh}

::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.app{max-width:1400px;margin:0 auto;padding:1.5rem}
.header{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.header h1{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:600;color:var(--cyan);letter-spacing:-.02em}
.header .badge{font-size:.7rem;padding:2px 8px;border-radius:99px;background:var(--blue-bg);color:var(--blue);border:1px solid rgba(59,130,246,.2);font-weight:600;text-transform:uppercase;letter-spacing:.05em}

.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.card-title{font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.06em}

.controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:end}
.field{display:flex;flex-direction:column;gap:.3rem}
.field label{font-size:.75rem;color:var(--tx3);font-weight:500;text-transform:uppercase;letter-spacing:.04em}
input[type="text"],input[type="number"],select{
  background:var(--bg3);border:1px solid var(--border2);color:var(--tx);padding:.5rem .75rem;
  border-radius:6px;font-size:.85rem;font-family:'DM Sans',sans-serif;outline:none;transition:border .15s;min-width:120px}
input:focus,select:focus{border-color:var(--blue)}
textarea{background:var(--bg3);border:1px solid var(--border2);color:var(--tx);padding:.5rem;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:.75rem;width:100%;resize:vertical;outline:none}

.btn{
  padding:.5rem 1.2rem;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;
  font-family:'DM Sans',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:.4rem}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue2)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:.35rem .8rem;font-size:.75rem}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:var(--green2)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--tx2)}
.btn-outline:hover{border-color:var(--tx2);color:var(--tx)}

.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.05em;padding:.5rem .6rem;text-align:left;border-bottom:1px solid var(--border2);white-space:nowrap}
td{padding:.5rem .6rem;border-bottom:1px solid var(--border);color:var(--tx2);white-space:nowrap}
tr:hover td{background:rgba(255,255,255,.02)}
tr.selected td{background:var(--blue-bg);color:var(--tx)}
.clickable{cursor:pointer}

.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-bar{height:2px;background:var(--bg3);overflow:hidden;border-radius:1px;margin:.5rem 0}
.loading-bar .fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));animation:load 1.5s ease-in-out infinite;transform-origin:left}
@keyframes load{0%{transform:scaleX(0)}50%{transform:scaleX(.7)}100%{transform:scaleX(0)}}

.score-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:900px){.score-grid{grid-template-columns:1fr}}
.score-total{font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;text-align:center;padding:1rem}
.score-total.positive{color:var(--green)}
.score-total.negative{color:var(--red)}
.score-total.neutral{color:var(--amber)}

.truth-table{width:100%;border-collapse:collapse;font-size:.8rem}
.truth-table th{font-family:'JetBrains Mono',monospace;font-size:.7rem;padding:.6rem .8rem;background:var(--bg3);border:1px solid var(--border);text-align:center;color:var(--tx2);text-transform:uppercase;letter-spacing:.04em}
.truth-table td{padding:.5rem .8rem;border:1px solid var(--border);text-align:center;font-family:'JetBrains Mono',monospace;font-size:.8rem}
.truth-table td:nth-child(2){text-align:left;font-family:'DM Sans',sans-serif}
.truth-table tr.section-header td{background:var(--bg3);font-weight:700;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:.8rem}
.truth-table tr.total-row td{background:var(--bg4);font-weight:700;color:var(--tx);font-size:.9rem;border-top:2px solid var(--border2)}
.val-pos{color:var(--green);font-weight:600}
.val-neg{color:var(--red);font-weight:600}
.val-zero{color:var(--tx3)}
.val-na{color:var(--tx3);font-style:italic}

.note{padding:.3rem .6rem;border-radius:4px;font-size:.75rem;margin:.2rem 0;font-family:'JetBrains Mono',monospace}
.note.pass{background:var(--green-bg);color:var(--green);border-left:3px solid var(--green)}
.note.fail{background:var(--red-bg);color:var(--red);border-left:3px solid var(--red)}
.note.adjust{background:var(--amber-bg);color:var(--amber);border-left:3px solid var(--amber)}

.diag-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.5rem}
.diag-item{background:var(--bg3);border-radius:6px;padding:.6rem .8rem}
.diag-label{font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em;font-weight:600}
.diag-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--tx);margin-top:.15rem}

.filing-frame{background:#fff;border-radius:var(--radius);overflow:hidden;margin-top:.75rem}
.filing-frame iframe{width:100%;height:600px;border:none}

.tabs{display:flex;gap:0;border-bottom:2px solid var(--border)}
.tab{padding:.5rem 1.2rem;font-size:.8rem;font-weight:600;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--tx2)}
.tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}

.tab-panel{display:none;padding-top:1rem}
.tab-panel.active{display:block}

.steps{display:flex;gap:2rem;margin-bottom:1.5rem}
.step{display:flex;align-items:center;gap:.5rem}
.step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:700;border:2px solid var(--border2);color:var(--tx3);transition:all .2s}
.step.active .step-num{border-color:var(--cyan);color:var(--cyan);background:rgba(6,182,212,.1)}
.step.done .step-num{border-color:var(--green);color:var(--green);background:rgba(34,197,94,.1)}
.step-label{font-size:.8rem;color:var(--tx3);font-weight:500}
.step.active .step-label{color:var(--tx)}
.step.done .step-label{color:var(--green)}

.empty{text-align:center;padding:3rem;color:var(--tx3)}
.error-box{background:var(--red-bg);border:1px solid rgba(239,68,68,.2);color:var(--red);padding:.75rem 1rem;border-radius:var(--radius);font-size:.85rem;margin:.75rem 0}
.info-box{background:var(--blue-bg);border:1px solid rgba(59,130,246,.2);color:var(--blue);padding:.75rem 1rem;border-radius:var(--radius);font-size:.85rem;margin:.75rem 0}
.mt-1{margin-top:1rem}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>&#9670; SEC FORENSIC FILING ANALYZER</h1>
    <span class="badge">Claude-Powered</span>
  </div>

  <div class="steps">
    <div class="step active" id="step1"><span class="step-num">1</span><span class="step-label">Scan Filings</span></div>
    <div class="step" id="step2"><span class="step-num">2</span><span class="step-label">Select &amp; View</span></div>
    <div class="step" id="step3"><span class="step-num">3</span><span class="step-label">Analyze</span></div>
  </div>

  <!-- STEP 1 -->
  <div class="card" id="scan-card">
    <div class="card-header"><span class="card-title">&#9312; Filing Scanner</span></div>
    <div class="controls">
      <div class="field" style="flex:1;min-width:300px">
        <label>Tickers (comma-separated)</label>
        <input type="text" id="ticker-input" value="AAPL,MSFT,NVDA,AMZN,META,GOOGL,TSLA,AVGO,NFLX,COST,ADBE,AMD,CRM,INTC,QCOM,TXN,INTU,AMGN,BKNG,ISRG,PANW,CRWD,PLTR,APP,DASH,ARM" placeholder="AAPL,MSFT,...">
      </div>
      <div class="field">
        <label>Lookback (days)</label>
        <input type="number" id="days-input" value="30" min="1" max="120" style="width:80px">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="scan-btn" onclick="startScan()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          Scan SEC
        </button>
      </div>
    </div>
    <div id="scan-progress" class="hidden mt-1">
      <div class="loading-bar"><div class="fill"></div></div>
      <div style="font-size:.75rem;color:var(--tx3)" id="scan-status">Scanning...</div>
    </div>
    <div id="scan-results" class="mt-1"></div>
  </div>

  <!-- STEP 2 -->
  <div class="card hidden" id="select-card">
    <div class="card-header"><span class="card-title">&#9313; Filing Selection</span></div>
    <div id="filing-select-area"></div>
    <div class="tabs mt-1">
      <div class="tab active" data-tab="view-tab" onclick="switchTab(this)">Filing View</div>
      <div class="tab" data-tab="pair-tab" onclick="switchTab(this)">8K / 10Q Pair</div>
    </div>
    <div class="tab-panel active" id="view-tab">
      <div id="filing-viewer"><div class="empty">Select a filing above to preview it.</div></div>
    </div>
    <div class="tab-panel" id="pair-tab">
      <div id="pair-info"><div class="empty">Pair detection will run when you select a filing.</div></div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="card hidden" id="analyze-card">
    <div class="card-header">
      <span class="card-title">&#9314; Forensic Analysis</span>
      <button class="btn btn-green" id="analyze-btn" onclick="runAnalysis()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4m0 12v4M2 12h4m12 0h4m-3.5-6.5L17 7m-10 10-1.5 1.5M20.5 17.5 19 17M5 7 3.5 5.5"/></svg>
        Run Claude Analysis
      </button>
    </div>
    <div id="analyze-progress" class="hidden">
      <div class="loading-bar"><div class="fill"></div></div>
      <div style="font-size:.75rem;color:var(--tx3)">Extracting financials via Claude API... This may take 30-60 seconds.</div>
    </div>
    <div id="analyze-results"></div>
  </div>
</div>

<script>
var STATE = {
  scanResults: [],
  selectedTicker: null,
  selectedFiling: null,
  selectedCompany: null,
  selectedCik: null,
  pairFiling: null,
  analysisResult: null
};

var API = '';

function $(id) { return document.getElementById(id); }
function show(id) { $(id).classList.remove('hidden'); }
function hide(id) { $(id).classList.add('hidden'); }

function setStep(n) {
  [1,2,3].forEach(function(i) {
    var el = $('step'+i);
    el.classList.remove('active','done');
    if (i < n) el.classList.add('done');
    if (i === n) el.classList.add('active');
  });
}

function escHtml(s) {
  if (s === null || s === undefined) return '';
  var d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function fmtVal(v) {
  if (v === null || v === undefined) return '<span class="val-na">N/A</span>';
  var n = Number(v);
  if (isNaN(n)) return '<span class="val-na">N/A</span>';
  if (n === 0) return '<span class="val-zero">0</span>';
  if (n > 0) return '<span class="val-pos">+' + n + '</span>';
  return '<span class="val-neg">' + n + '</span>';
}

function fmtPct(v) {
  if (v === null || v === undefined) return 'N/A';
  return (v * 100).toFixed(1) + '%';
}

function fmtBps(v) {
  if (v === null || v === undefined) return 'N/A';
  return v.toFixed(0) + ' bps';
}

function switchTab(el) {
  var tabId = el.getAttribute('data-tab');
  var tabs = el.parentElement.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
  el.classList.add('active');
  var panels = el.parentElement.parentElement.querySelectorAll('.tab-panel');
  for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
  $(tabId).classList.add('active');
}

/* ═══════ STEP 1: SCAN ═══════ */

async function startScan() {
  var tickers = $('ticker-input').value.split(',').map(function(t){ return t.trim().toUpperCase(); }).filter(Boolean);
  var days = parseInt($('days-input').value) || 30;
  if (!tickers.length) return;

  $('scan-btn').disabled = true;
  show('scan-progress');
  $('scan-results').innerHTML = '';
  STATE.scanResults = [];

  var batches = [];
  for (var i = 0; i < tickers.length; i += 10) {
    batches.push(tickers.slice(i, i + 10));
  }

  var processed = 0;
  for (var b = 0; b < batches.length; b++) {
    var batch = batches[b];
    $('scan-status').textContent = 'Scanning batch ' + (processed + 1) + '-' + Math.min(processed + batch.length, tickers.length) + ' of ' + tickers.length + '...';
    try {
      var resp = await fetch(API + '/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tickers: batch, days: days })
      });
      var data = await resp.json();
      if (data.ok && data.results) {
        STATE.scanResults = STATE.scanResults.concat(data.results);
      }
    } catch (e) {
      console.error('Scan error:', e);
    }
    processed += batch.length;
  }

  hide('scan-progress');
  $('scan-btn').disabled = false;
  renderScanResults();
}

function renderScanResults() {
  var el = $('scan-results');
  if (!STATE.scanResults.length) {
    el.innerHTML = '<div class="empty">No qualifying filings found.</div>';
    return;
  }

  var html = '<div class="tbl-wrap"><table><thead><tr>';
  html += '<th>Ticker</th><th>Company</th><th>Form</th><th>Filing Date</th><th>Report Period</th><th>Action</th>';
  html += '</tr></thead><tbody>';

  for (var i = 0; i < STATE.scanResults.length; i++) {
    var r = STATE.scanResults[i];
    var f = r.filings[0];
    var formBg = f.form === '8-K' ? 'var(--amber-bg);color:var(--amber)' : 'var(--blue-bg);color:var(--blue)';
    html += '<tr>';
    html += '<td style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--cyan)">' + escHtml(r.ticker) + '</td>';
    html += '<td>' + escHtml(r.company) + '</td>';
    html += '<td><span style="padding:2px 6px;border-radius:4px;font-size:.7rem;font-weight:600;background:' + formBg + '">' + escHtml(f.form) + '</span></td>';
    html += '<td>' + escHtml(f.filing_date) + '</td>';
    html += '<td>' + escHtml(f.report_period || 'N/A') + '</td>';
    html += '<td><button class="btn btn-sm btn-outline" data-idx="' + i + '" onclick="selectByIndex(' + i + ')">Select &rarr;</button></td>';
    html += '</tr>';
  }

  html += '</tbody></table></div>';
  el.innerHTML = html;
}

/* ═══════ STEP 2: SELECT & VIEW ═══════ */

function selectByIndex(idx) {
  var r = STATE.scanResults[idx];
  if (!r) return;

  STATE.selectedTicker = r.ticker;
  STATE.selectedCik = r.cik;
  STATE.selectedCompany = r.company;
  STATE.selectedFiling = r.filings[0];

  show('select-card');
  show('analyze-card');
  setStep(2);

  var html = '<div style="margin-bottom:.75rem;font-family:JetBrains Mono,monospace;font-size:1rem">';
  html += '<span style="color:var(--cyan);font-weight:700">' + escHtml(r.ticker) + '</span>';
  html += '<span style="color:var(--tx2);margin-left:.5rem">' + escHtml(r.company) + '</span>';
  html += '</div>';
  html += '<div class="controls" style="margin-bottom:.5rem"><div class="field" style="flex:1"><label>Filing</label><select id="filing-select" onchange="onFilingSelect()">';

  for (var j = 0; j < r.filings.length; j++) {
    var fj = r.filings[j];
    var lbl = fj.filing_date + ' | ' + fj.form + ' | ' + fj.accession_number;
    html += '<option value="' + j + '">' + escHtml(lbl) + '</option>';
  }

  html += '</select></div>';
  html += '<div class="field"><label>&nbsp;</label><button class="btn btn-sm btn-primary" onclick="loadFiling()">Load Filing</button></div></div>';
  $('filing-select-area').innerHTML = html;

  findPair();
}

function onFilingSelect() {
  var idx = parseInt($('filing-select').value);
  var r = null;
  for (var i = 0; i < STATE.scanResults.length; i++) {
    if (STATE.scanResults[i].ticker === STATE.selectedTicker) { r = STATE.scanResults[i]; break; }
  }
  if (r && r.filings[idx]) {
    STATE.selectedFiling = r.filings[idx];
    findPair();
  }
}

async function loadFiling() {
  if (!STATE.selectedFiling) return;
  var f = STATE.selectedFiling;
  $('filing-viewer').innerHTML = '<div style="padding:1rem"><div class="spinner"></div> Loading filing...</div>';
  try {
    var url = API + '/api/filing?cik=' + STATE.selectedCik + '&accession=' + f.accession_number + '&doc=' + encodeURIComponent(f.primary_document) + '&form=' + f.form;
    var resp = await fetch(url);
    var data = await resp.json();
    if (data.ok) {
      var blob = new Blob([data.html], { type: 'text/html' });
      var blobUrl = URL.createObjectURL(blob);
      $('filing-viewer').innerHTML = '<div class="filing-frame"><iframe src="' + blobUrl + '" sandbox="allow-same-origin"></iframe></div>';
    } else {
      $('filing-viewer').innerHTML = '<div class="error-box">' + escHtml(data.error) + '</div>';
    }
  } catch (e) {
    $('filing-viewer').innerHTML = '<div class="error-box">' + escHtml(e.message) + '</div>';
  }
}

async function findPair() {
  if (!STATE.selectedFiling) return;
  var f = STATE.selectedFiling;
  $('pair-info').innerHTML = '<div style="padding:.5rem"><div class="spinner"></div> Finding 8K/10Q pair...</div>';
  try {
    var resp = await fetch(API + '/api/pair?cik=' + STATE.selectedCik + '&form=' + f.form + '&filing_date=' + f.filing_date);
    var data = await resp.json();
    STATE.pairFiling = data.pair;
    renderPairInfo();
  } catch (e) {
    $('pair-info').innerHTML = '<div class="error-box">' + escHtml(e.message) + '</div>';
  }
}

function renderPairInfo() {
  var f = STATE.selectedFiling;
  var p = STATE.pairFiling;
  var is8k = f.form === '8-K';
  var ek = is8k ? f : p;
  var tq = is8k ? p : f;

  var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">';

  html += '<div style="background:var(--bg3);border-radius:6px;padding:1rem">';
  html += '<div style="font-weight:600;color:var(--amber);margin-bottom:.5rem;font-size:.85rem">8-K (Item 2.02)</div>';
  if (ek) {
    html += '<div style="font-size:.8rem;color:var(--tx2)">Date: ' + escHtml(ek.filing_date) + '<br>Accession: ' + escHtml(ek.accession_number) + '</div>';
  } else {
    html += '<div style="color:var(--tx3);font-size:.8rem">Not found</div>';
  }
  html += '</div>';

  html += '<div style="background:var(--bg3);border-radius:6px;padding:1rem">';
  html += '<div style="font-weight:600;color:var(--blue);margin-bottom:.5rem;font-size:.85rem">10-Q</div>';
  if (tq) {
    html += '<div style="font-size:.8rem;color:var(--tx2)">Date: ' + escHtml(tq.filing_date) + '<br>Accession: ' + escHtml(tq.accession_number) + '</div>';
  } else {
    html += '<div style="color:var(--tx3);font-size:.8rem">Not found within 120 days</div>';
  }
  html += '</div></div>';

  $('pair-info').innerHTML = html;
}

/* ═══════ STEP 3: ANALYZE ═══════ */

async function runAnalysis() {
  if (!STATE.selectedFiling) return;
  var f = STATE.selectedFiling;
  var is8k = f.form === '8-K';
  var ek = is8k ? f : STATE.pairFiling;
  var tq = is8k ? STATE.pairFiling : f;

  $('analyze-btn').disabled = true;
  show('analyze-progress');
  $('analyze-results').innerHTML = '';
  setStep(3);

  try {
    var resp = await fetch(API + '/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cik: STATE.selectedCik,
        ticker: STATE.selectedTicker,
        company: STATE.selectedCompany,
        eight_k: ek,
        ten_q: tq
      })
    });
    var data = await resp.json();
    if (data.ok) {
      STATE.analysisResult = data;
      renderAnalysis();
    } else {
      $('analyze-results').innerHTML = '<div class="error-box"><strong>Analysis failed:</strong> ' + escHtml(data.error) + '</div>';
    }
  } catch (e) {
    $('analyze-results').innerHTML = '<div class="error-box">' + escHtml(e.message) + '</div>';
  } finally {
    hide('analyze-progress');
    $('analyze-btn').disabled = false;
  }
}

function renderAnalysis() {
  var r = STATE.analysisResult;
  if (!r) return;
  var s8 = r.eight_k ? r.eight_k.scorecard : null;
  var s10 = r.ten_q ? r.ten_q.scorecard : null;
  var html = '';

  // Truth Table
  html += '<div class="card" style="margin-top:1rem;border-color:var(--border2)">';
  html += '<div class="card-header"><span class="card-title">Forensic Truth Table</span></div>';
  html += buildTruthTable(s8, s10);
  html += '</div>';

  // Score Cards
  html += '<div class="score-grid mt-1">';

  html += '<div class="card" style="border-color:var(--amber);border-width:1px 1px 1px 3px">';
  html += '<div class="card-header"><span class="card-title" style="color:var(--amber)">8-K Scorecard</span></div>';
  if (s8) {
    var c8 = s8.total >= 60 ? 'positive' : s8.total < 40 ? 'negative' : 'neutral';
    html += '<div class="score-total ' + c8 + '">' + s8.total + '</div>';
    html += renderNotes(s8.notes);
    html += renderDiagnostics(s8.diagnostics);
  } else {
    html += '<div class="empty">N/A</div>';
  }
  html += '</div>';

  html += '<div class="card" style="border-color:var(--blue);border-width:1px 1px 1px 3px">';
  html += '<div class="card-header"><span class="card-title" style="color:var(--blue)">10-Q Scorecard</span></div>';
  if (s10) {
    var c10 = s10.total >= 60 ? 'positive' : s10.total < 40 ? 'negative' : 'neutral';
    html += '<div class="score-total ' + c10 + '">' + s10.total + '</div>';
    html += renderNotes(s10.notes);
    html += renderDiagnostics(s10.diagnostics);
  } else {
    html += '<div class="empty">N/A</div>';
  }
  html += '</div></div>';

  // Raw JSON
  html += '<div class="card mt-1"><div class="card-header"><span class="card-title">Raw Extracted JSON</span></div>';
  html += '<div class="score-grid">';
  html += '<div><div style="font-size:.75rem;color:var(--amber);font-weight:600;margin-bottom:.3rem">8-K JSON</div>';
  html += '<textarea rows="16" readonly>' + (r.eight_k ? JSON.stringify(r.eight_k.json, null, 2) : 'N/A') + '</textarea></div>';
  html += '<div><div style="font-size:.75rem;color:var(--blue);font-weight:600;margin-bottom:.3rem">10-Q JSON</div>';
  html += '<textarea rows="16" readonly>' + (r.ten_q ? JSON.stringify(r.ten_q.json, null, 2) : 'N/A') + '</textarea></div>';
  html += '</div></div>';

  $('analyze-results').innerHTML = html;
}

function buildTruthTable(s8, s10) {
  var rows = [
    { sno: '1', label: 'Base Score', key: 'base' },
    { sno: '2', label: 'Alpha Scores (Bonuses)', section: true },
    { sno: '2(a)', label: 'Snowflake Rule', key: 'snowflake' },
    { sno: '2(b)', label: 'Amazon Exception', key: 'amazon' },
    { sno: '2(c)', label: 'Margin Rocket', key: 'margin_rocket' },
    { sno: '3', label: 'Penalties', section: true },
    { sno: '3(a)', label: 'Oracle Rule', key: 'oracle' },
    { sno: '3(b)', label: 'Target Rule', key: 'target' },
    { sno: '3(c)', label: 'Zombie Check', key: 'zombie' },
    { sno: '3(d)', label: 'SBC Death Ratio', key: 'sbc_death_ratio' },
    { sno: '3(e)', label: 'Channel Stuffing', key: 'channel_stuffing' },
    { sno: '3(f)', label: 'Quality Trap', key: 'quality_trap' },
    { sno: '4', label: 'Waivers', section: true },
    { sno: '4(a)', label: 'Gain Waiver', key: 'gain_waiver' },
    { sno: '4(b)', label: 'Kitchen Sink Bonus', key: 'kitchen_sink' },
    { sno: '', label: 'TOTAL', key: '_total', total: true }
  ];

  function getVal(sc, key) {
    if (!sc) return null;
    if (key === '_total') return sc.total;
    return (sc.points && sc.points[key] !== undefined) ? sc.points[key] : null;
  }

  var html = '<div class="tbl-wrap"><table class="truth-table"><thead><tr>';
  html += '<th style="width:60px">S. No</th><th>Particulars</th><th style="width:80px">8-K</th><th style="width:80px">10-Q</th><th style="width:120px">Delta</th>';
  html += '</tr></thead><tbody>';

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    if (row.section) {
      html += '<tr class="section-header"><td>' + row.sno + '</td><td colspan="4">' + row.label + '</td></tr>';
      continue;
    }
    var v8 = getVal(s8, row.key);
    var v10 = getVal(s10, row.key);
    var delta = (v8 !== null && v10 !== null) ? v10 - v8 : null;
    var cls = row.total ? ' class="total-row"' : '';
    html += '<tr' + cls + '>';
    html += '<td>' + row.sno + '</td>';
    html += '<td style="font-weight:' + (row.total ? 700 : 400) + '">' + row.label + '</td>';
    html += '<td>' + fmtVal(v8) + '</td>';
    html += '<td>' + fmtVal(v10) + '</td>';
    html += '<td>' + fmtVal(delta) + '</td>';
    html += '</tr>';
  }

  html += '</tbody></table></div>';
  return html;
}

function renderNotes(notes) {
  if (!notes || !notes.length) return '<div style="color:var(--tx3);font-size:.75rem;padding:.5rem">No triggered rules.</div>';
  var html = '<div style="margin-top:.5rem">';
  for (var i = 0; i < notes.length; i++) {
    var n = notes[i];
    var cls = 'adjust';
    if (n.indexOf('PASS') === 0) cls = 'pass';
    else if (n.indexOf('FAIL') === 0) cls = 'fail';
    html += '<div class="note ' + cls + '">' + escHtml(n) + '</div>';
  }
  html += '</div>';
  return html;
}

function renderDiagnostics(diag) {
  if (!diag) return '';
  var items = [
    { label: 'Rev Growth', val: diag.rev_growth, fmt: fmtPct },
    { label: 'RPO Growth', val: diag.rpo_growth, fmt: fmtPct },
    { label: 'AR Growth', val: diag.ar_growth, fmt: fmtPct },
    { label: 'GM Change (bps)', val: diag.gm_bps_change, fmt: fmtBps },
    { label: 'FCF Proxy', val: diag.fcf_proxy, fmt: function(v) { return v != null ? v.toLocaleString() : 'N/A'; } },
    { label: 'OCF/NI', val: diag.ocf_net_income_ratio, fmt: function(v) { return v != null ? v.toFixed(2) : 'N/A'; } },
    { label: 'Int/OpInc', val: diag.interest_op_income_ratio, fmt: function(v) { return v != null ? v.toFixed(2) : 'N/A'; } },
    { label: 'SBC/OCF', val: diag.sbc_ocf_ratio, fmt: function(v) { return v != null ? v.toFixed(2) : 'N/A'; } }
  ];
  var html = '<div class="diag-grid" style="margin-top:.75rem">';
  for (var i = 0; i < items.length; i++) {
    var it = items[i];
    var display = (it.val !== null && it.val !== undefined) ? it.fmt(it.val) : 'N/A';
    html += '<div class="diag-item"><div class="diag-label">' + it.label + '</div><div class="diag-value">' + display + '</div></div>';
  }
  html += '</div>';
  return html;
}
</script>
</body>
</html>
