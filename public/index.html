<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEC Forensic Filing Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e17;--bg2:#111827;--bg3:#1a2235;--bg4:#243049;
  --tx:#e2e8f0;--tx2:#94a3b8;--tx3:#64748b;
  --green:#22c55e;--green2:#16a34a;--green-bg:rgba(34,197,94,.08);
  --red:#ef4444;--red2:#dc2626;--red-bg:rgba(239,68,68,.08);
  --blue:#3b82f6;--blue2:#2563eb;--blue-bg:rgba(59,130,246,.08);
  --amber:#f59e0b;--amber-bg:rgba(245,158,11,.08);
  --cyan:#06b6d4;
  --border:#1e293b;--border2:#334155;
  --radius:8px;
}
html{font-size:14px}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',sans-serif;line-height:1.6;min-height:100vh}

/* ── scrollbar ── */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* ── layout ── */
.app{max-width:1400px;margin:0 auto;padding:1.5rem}
.header{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.header h1{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:600;color:var(--cyan);letter-spacing:-.02em}
.header .badge{font-size:.7rem;padding:2px 8px;border-radius:99px;background:var(--blue-bg);color:var(--blue);border:1px solid rgba(59,130,246,.2);font-weight:600;text-transform:uppercase;letter-spacing:.05em}

/* ── cards ── */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.card-title{font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.06em}

/* ── controls ── */
.controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:end}
.field{display:flex;flex-direction:column;gap:.3rem}
.field label{font-size:.75rem;color:var(--tx3);font-weight:500;text-transform:uppercase;letter-spacing:.04em}
input[type="text"],input[type="number"],select{
  background:var(--bg3);border:1px solid var(--border2);color:var(--tx);padding:.5rem .75rem;
  border-radius:6px;font-size:.85rem;font-family:'DM Sans',sans-serif;outline:none;transition:border .15s;min-width:120px}
input:focus,select:focus{border-color:var(--blue)}
textarea{background:var(--bg3);border:1px solid var(--border2);color:var(--tx);padding:.5rem;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:.75rem;width:100%;resize:vertical;outline:none}

.btn{
  padding:.5rem 1.2rem;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;
  font-family:'DM Sans',sans-serif;transition:all .15s;display:inline-flex;align-items:center;gap:.4rem}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue2)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:.35rem .8rem;font-size:.75rem}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:var(--green2)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--tx2)}
.btn-outline:hover{border-color:var(--tx2);color:var(--tx)}

/* ── table ── */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.05em;padding:.5rem .6rem;text-align:left;border-bottom:1px solid var(--border2);white-space:nowrap}
td{padding:.5rem .6rem;border-bottom:1px solid var(--border);color:var(--tx2);white-space:nowrap}
tr:hover td{background:rgba(255,255,255,.02)}
tr.selected td{background:var(--blue-bg);color:var(--tx)}
.clickable{cursor:pointer}

/* ── spinner ── */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-bar{height:2px;background:var(--bg3);overflow:hidden;border-radius:1px;margin:.5rem 0}
.loading-bar .fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));animation:load 1.5s ease-in-out infinite;transform-origin:left}
@keyframes load{0%{transform:scaleX(0)}50%{transform:scaleX(.7)}100%{transform:scaleX(0)}}

/* ── scorecard ── */
.score-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:900px){.score-grid{grid-template-columns:1fr}}
.score-total{font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;text-align:center;padding:1rem}
.score-total.positive{color:var(--green)}
.score-total.negative{color:var(--red)}
.score-total.neutral{color:var(--amber)}

.truth-table{width:100%;border-collapse:collapse;font-size:.8rem}
.truth-table th{font-family:'JetBrains Mono',monospace;font-size:.7rem;padding:.6rem .8rem;background:var(--bg3);border:1px solid var(--border);text-align:center;color:var(--tx2);text-transform:uppercase;letter-spacing:.04em}
.truth-table td{padding:.5rem .8rem;border:1px solid var(--border);text-align:center;font-family:'JetBrains Mono',monospace;font-size:.8rem}
.truth-table td:nth-child(2){text-align:left;font-family:'DM Sans',sans-serif}
.truth-table tr.section-header td{background:var(--bg3);font-weight:700;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:.8rem}
.truth-table tr.total-row td{background:var(--bg4);font-weight:700;color:var(--tx);font-size:.9rem;border-top:2px solid var(--border2)}
.val-pos{color:var(--green);font-weight:600}
.val-neg{color:var(--red);font-weight:600}
.val-zero{color:var(--tx3)}
.val-na{color:var(--tx3);font-style:italic}

.note{padding:.3rem .6rem;border-radius:4px;font-size:.75rem;margin:.2rem 0;font-family:'JetBrains Mono',monospace}
.note.pass{background:var(--green-bg);color:var(--green);border-left:3px solid var(--green)}
.note.fail{background:var(--red-bg);color:var(--red);border-left:3px solid var(--red)}
.note.adjust{background:var(--amber-bg);color:var(--amber);border-left:3px solid var(--amber)}

.diag-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.5rem}
.diag-item{background:var(--bg3);border-radius:6px;padding:.6rem .8rem}
.diag-label{font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em;font-weight:600}
.diag-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--tx);margin-top:.15rem}

/* ── filing viewer ── */
.filing-frame{background:#fff;border-radius:var(--radius);overflow:hidden;margin-top:.75rem}
.filing-frame iframe{width:100%;height:600px;border:none}

/* ── tabs ── */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border)}
.tab{padding:.5rem 1.2rem;font-size:.8rem;font-weight:600;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--tx2)}
.tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}

.tab-panel{display:none;padding-top:1rem}
.tab-panel.active{display:block}

/* ── step indicator ── */
.steps{display:flex;gap:2rem;margin-bottom:1.5rem}
.step{display:flex;align-items:center;gap:.5rem}
.step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:700;border:2px solid var(--border2);color:var(--tx3);transition:all .2s}
.step.active .step-num{border-color:var(--cyan);color:var(--cyan);background:rgba(6,182,212,.1)}
.step.done .step-num{border-color:var(--green);color:var(--green);background:rgba(34,197,94,.1)}
.step-label{font-size:.8rem;color:var(--tx3);font-weight:500}
.step.active .step-label{color:var(--tx)}
.step.done .step-label{color:var(--green)}

/* ── misc ── */
.empty{text-align:center;padding:3rem;color:var(--tx3)}
.error-box{background:var(--red-bg);border:1px solid rgba(239,68,68,.2);color:var(--red);padding:.75rem 1rem;border-radius:var(--radius);font-size:.85rem;margin:.75rem 0}
.info-box{background:var(--blue-bg);border:1px solid rgba(59,130,246,.2);color:var(--blue);padding:.75rem 1rem;border-radius:var(--radius);font-size:.85rem;margin:.75rem 0}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.gap-sm{gap:.5rem}
.mt-1{margin-top:1rem}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <h1>◆ SEC FORENSIC FILING ANALYZER</h1>
    <span class="badge">Claude-Powered</span>
  </div>

  <!-- Steps -->
  <div class="steps">
    <div class="step active" id="step1"><span class="step-num">1</span><span class="step-label">Scan Filings</span></div>
    <div class="step" id="step2"><span class="step-num">2</span><span class="step-label">Select & View</span></div>
    <div class="step" id="step3"><span class="step-num">3</span><span class="step-label">Analyze</span></div>
  </div>

  <!-- STEP 1: SCAN -->
  <div class="card" id="scan-card">
    <div class="card-header">
      <span class="card-title">① Filing Scanner</span>
    </div>
    <div class="controls">
      <div class="field" style="flex:1;min-width:300px">
        <label>Tickers (comma-separated)</label>
        <input type="text" id="ticker-input" value="AAPL,MSFT,NVDA,AMZN,META,GOOGL,TSLA,AVGO,NFLX,COST,ADBE,AMD,CRM,INTC,QCOM,TXN,INTU,AMGN,BKNG,ISRG,PANW,CRWD,PLTR,APP,DASH,ARM" placeholder="AAPL,MSFT,...">
      </div>
      <div class="field">
        <label>Lookback (days)</label>
        <input type="number" id="days-input" value="30" min="1" max="120" style="width:80px">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="scan-btn" onclick="startScan()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          Scan SEC
        </button>
      </div>
    </div>
    <div id="scan-progress" class="hidden mt-1">
      <div class="loading-bar"><div class="fill"></div></div>
      <div style="font-size:.75rem;color:var(--tx3)" id="scan-status">Scanning...</div>
    </div>
    <div id="scan-results" class="mt-1"></div>
  </div>

  <!-- STEP 2: SELECT & VIEW -->
  <div class="card hidden" id="select-card">
    <div class="card-header">
      <span class="card-title">② Filing Selection</span>
    </div>
    <div id="filing-select-area"></div>
    <div class="tabs mt-1" id="filing-tabs">
      <div class="tab active" data-tab="view-tab" onclick="switchTab(this)">Filing View</div>
      <div class="tab" data-tab="pair-tab" onclick="switchTab(this)">8K / 10Q Pair</div>
    </div>
    <div class="tab-panel active" id="view-tab">
      <div id="filing-viewer"><div class="empty">Select a filing above to preview it.</div></div>
    </div>
    <div class="tab-panel" id="pair-tab">
      <div id="pair-info"><div class="empty">Pair detection will run when you select a filing.</div></div>
    </div>
  </div>

  <!-- STEP 3: ANALYZE -->
  <div class="card hidden" id="analyze-card">
    <div class="card-header">
      <span class="card-title">③ Forensic Analysis</span>
      <button class="btn btn-green" id="analyze-btn" onclick="runAnalysis()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4m0 12v4M2 12h4m12 0h4m-3.5-6.5L17 7m-10 10-1.5 1.5M20.5 17.5 19 17M5 7 3.5 5.5"/></svg>
        Run Claude Analysis
      </button>
    </div>
    <div id="analyze-progress" class="hidden">
      <div class="loading-bar"><div class="fill"></div></div>
      <div style="font-size:.75rem;color:var(--tx3)">Extracting financials via Claude API... This may take 30-60 seconds.</div>
    </div>
    <div id="analyze-results"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════
const STATE = {
  scanResults: [],
  selectedTicker: null,
  selectedFiling: null,
  selectedCompany: null,
  selectedCik: null,
  pairFiling: null,
  analysisResult: null,
};

const API = '';  // same origin

// ═══════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════
function $(id) { return document.getElementById(id); }
function show(id) { $(id).classList.remove('hidden'); }
function hide(id) { $(id).classList.add('hidden'); }
function setStep(n) {
  [1,2,3].forEach(i => {
    const el = $('step'+i);
    el.classList.remove('active','done');
    if (i < n) el.classList.add('done');
    if (i === n) el.classList.add('active');
  });
}

function fmtVal(v) {
  if (v === null || v === undefined) return '<span class="val-na">N/A</span>';
  const n = Number(v);
  if (isNaN(n)) return '<span class="val-na">N/A</span>';
  if (n === 0) return '<span class="val-zero">0</span>';
  if (n > 0) return `<span class="val-pos">+${n}</span>`;
  return `<span class="val-neg">${n}</span>`;
}

function fmtPct(v) {
  if (v === null || v === undefined) return 'N/A';
  return (v * 100).toFixed(1) + '%';
}

function fmtBps(v) {
  if (v === null || v === undefined) return 'N/A';
  return v.toFixed(0) + ' bps';
}

function switchTab(el) {
  const tabId = el.dataset.tab;
  el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  el.parentElement.parentElement.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  $(tabId).classList.add('active');
}

// ═══════════════════════════════════════════════
// STEP 1: SCAN
// ═══════════════════════════════════════════════
async function startScan() {
  const tickers = $('ticker-input').value.split(',').map(t => t.trim().toUpperCase()).filter(Boolean);
  const days = parseInt($('days-input').value) || 30;
  if (!tickers.length) return;

  $('scan-btn').disabled = true;
  show('scan-progress');
  $('scan-results').innerHTML = '';
  STATE.scanResults = [];

  // batch into groups of 10
  const batches = [];
  for (let i = 0; i < tickers.length; i += 10) {
    batches.push(tickers.slice(i, i + 10));
  }

  let processed = 0;
  for (const batch of batches) {
    $('scan-status').textContent = `Scanning batch ${processed+1}-${Math.min(processed+batch.length, tickers.length)} of ${tickers.length}...`;
    try {
      const resp = await fetch(API + '/api/scan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ tickers: batch, days })
      });
      const data = await resp.json();
      if (data.ok && data.results) {
        STATE.scanResults.push(...data.results);
      }
    } catch (e) {
      console.error('Scan batch error:', e);
    }
    processed += batch.length;
  }

  hide('scan-progress');
  $('scan-btn').disabled = false;
  renderScanResults();
}

function renderScanResults() {
  const el = $('scan-results');
  if (!STATE.scanResults.length) {
    el.innerHTML = '<div class="empty">No qualifying filings found in the selected timeframe.</div>';
    return;
  }

  let html = '<div class="tbl-wrap"><table><thead><tr>';
  html += '<th>Ticker</th><th>Company</th><th>Form</th><th>Filing Date</th><th>Report Period</th><th>Action</th>';
  html += '</tr></thead><tbody>';

  for (const r of STATE.scanResults) {
    const f = r.filings[0];
    html += `<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--cyan)">${r.ticker}</td>
      <td>${r.company}</td>
      <td><span style="padding:2px 6px;border-radius:4px;font-size:.7rem;font-weight:600;background:${f.form==='8-K'?'var(--amber-bg);color:var(--amber)':'var(--blue-bg);color:var(--blue)'}">${f.form}</span></td>
      <td>${f.filing_date}</td>
      <td>${f.report_period || 'N/A'}</td>
      <td><button class="btn btn-sm btn-outline" onclick="selectCompany('${r.ticker}','${r.cik}',${JSON.stringify(r.company).replace(/'/g,"\\'")},'${r.filings.length-1}')">Select →</button></td>
    </tr>`;
  }
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

// ═══════════════════════════════════════════════
// STEP 2: SELECT & VIEW
// ═══════════════════════════════════════════════
function selectCompany(ticker, cik, company, _) {
  STATE.selectedTicker = ticker;
  STATE.selectedCik = cik;
  STATE.selectedCompany = company;
  show('select-card');
  setStep(2);

  const r = STATE.scanResults.find(x => x.ticker === ticker);
  if (!r) return;

  let html = `<div style="margin-bottom:.75rem;font-family:'JetBrains Mono',monospace;font-size:1rem">
    <span style="color:var(--cyan);font-weight:700">${ticker}</span>
    <span style="color:var(--tx2);margin-left:.5rem">${company}</span>
  </div>`;
  html += '<div class="controls" style="margin-bottom:.5rem"><div class="field" style="flex:1"><label>Filing</label><select id="filing-select" onchange="onFilingSelect()">';

  for (const f of r.filings) {
    html += `<option value='${JSON.stringify(f).replace(/'/g,"&#39;")}'>${f.filing_date} | ${f.form} | ${f.accession_number}</option>`;
  }
  html += '</select></div><div class="field"><label>&nbsp;</label><button class="btn btn-sm btn-primary" onclick="loadFiling()">Load Filing</button></div></div>';
  $('filing-select-area').innerHTML = html;

  // auto-select first
  STATE.selectedFiling = r.filings[0];
  findPair();
  show('analyze-card');
  setStep(2);
}

function onFilingSelect() {
  try {
    STATE.selectedFiling = JSON.parse($('filing-select').value);
    findPair();
  } catch(e) {}
}

async function loadFiling() {
  if (!STATE.selectedFiling) return;
  const f = STATE.selectedFiling;
  $('filing-viewer').innerHTML = '<div style="padding:1rem"><div class="spinner"></div> Loading filing...</div>';
  try {
    const resp = await fetch(API + `/api/filing?cik=${STATE.selectedCik}&accession=${f.accession_number}&doc=${f.primary_document}&form=${f.form}`);
    const data = await resp.json();
    if (data.ok) {
      const blob = new Blob([data.html], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      $('filing-viewer').innerHTML = `<div class="filing-frame"><iframe src="${url}" sandbox="allow-same-origin"></iframe></div>`;
    } else {
      $('filing-viewer').innerHTML = `<div class="error-box">${data.error}</div>`;
    }
  } catch(e) {
    $('filing-viewer').innerHTML = `<div class="error-box">${e.message}</div>`;
  }
}

async function findPair() {
  if (!STATE.selectedFiling) return;
  const f = STATE.selectedFiling;
  $('pair-info').innerHTML = '<div style="padding:.5rem"><div class="spinner"></div> Finding 8K/10Q pair...</div>';
  try {
    const resp = await fetch(API + `/api/pair?cik=${STATE.selectedCik}&form=${f.form}&filing_date=${f.filing_date}`);
    const data = await resp.json();
    STATE.pairFiling = data.pair;
    renderPairInfo();
  } catch(e) {
    $('pair-info').innerHTML = `<div class="error-box">${e.message}</div>`;
  }
}

function renderPairInfo() {
  const f = STATE.selectedFiling;
  const p = STATE.pairFiling;
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">';

  // 8K card
  const is8k = f.form === '8-K';
  const ek = is8k ? f : p;
  html += `<div style="background:var(--bg3);border-radius:6px;padding:1rem">
    <div style="font-weight:600;color:var(--amber);margin-bottom:.5rem;font-size:.85rem">8-K (Item 2.02)</div>`;
  if (ek) {
    html += `<div style="font-size:.8rem;color:var(--tx2)">Date: ${ek.filing_date}<br>Accession: ${ek.accession_number}</div>`;
  } else {
    html += '<div style="color:var(--tx3);font-size:.8rem">Not found</div>';
  }
  html += '</div>';

  // 10Q card
  const tq = is8k ? p : f;
  html += `<div style="background:var(--bg3);border-radius:6px;padding:1rem">
    <div style="font-weight:600;color:var(--blue);margin-bottom:.5rem;font-size:.85rem">10-Q</div>`;
  if (tq) {
    html += `<div style="font-size:.8rem;color:var(--tx2)">Date: ${tq.filing_date}<br>Accession: ${tq.accession_number}</div>`;
  } else {
    html += '<div style="color:var(--tx3);font-size:.8rem">Not found within 120 days</div>';
  }
  html += '</div></div>';

  $('pair-info').innerHTML = html;
}

// ═══════════════════════════════════════════════
// STEP 3: ANALYZE
// ═══════════════════════════════════════════════
async function runAnalysis() {
  if (!STATE.selectedFiling) return;
  const f = STATE.selectedFiling;
  const is8k = f.form === '8-K';
  const ek = is8k ? f : STATE.pairFiling;
  const tq = is8k ? STATE.pairFiling : f;

  $('analyze-btn').disabled = true;
  show('analyze-progress');
  $('analyze-results').innerHTML = '';
  setStep(3);

  try {
    const resp = await fetch(API + '/api/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        cik: STATE.selectedCik,
        ticker: STATE.selectedTicker,
        company: STATE.selectedCompany,
        eight_k: ek,
        ten_q: tq,
      })
    });
    const data = await resp.json();
    if (data.ok) {
      STATE.analysisResult = data;
      renderAnalysis();
    } else {
      $('analyze-results').innerHTML = `<div class="error-box"><strong>Analysis failed:</strong> ${data.error}</div>`;
    }
  } catch(e) {
    $('analyze-results').innerHTML = `<div class="error-box">${e.message}</div>`;
  } finally {
    hide('analyze-progress');
    $('analyze-btn').disabled = false;
  }
}

function renderAnalysis() {
  const r = STATE.analysisResult;
  if (!r) return;

  const s8 = r.eight_k?.scorecard;
  const s10 = r.ten_q?.scorecard;

  let html = '';

  // ── Truth Table ──
  html += '<div class="card" style="margin-top:1rem;border-color:var(--border2)">';
  html += '<div class="card-header"><span class="card-title">Forensic Truth Table — Points & Delta</span></div>';
  html += buildTruthTable(s8, s10);
  html += '</div>';

  // ── Score cards side by side ──
  html += '<div class="score-grid mt-1">';

  // 8K
  html += '<div class="card" style="border-color:var(--amber);border-width:1px 1px 1px 3px">';
  html += '<div class="card-header"><span class="card-title" style="color:var(--amber)">8-K Scorecard</span></div>';
  if (s8) {
    const cls = s8.total >= 60 ? 'positive' : s8.total < 40 ? 'negative' : 'neutral';
    html += `<div class="score-total ${cls}">${s8.total}</div>`;
    html += renderNotes(s8.notes);
    html += renderDiagnostics(s8.diagnostics);
  } else {
    html += '<div class="empty">N/A — No 8-K analyzed</div>';
  }
  html += '</div>';

  // 10Q
  html += '<div class="card" style="border-color:var(--blue);border-width:1px 1px 1px 3px">';
  html += '<div class="card-header"><span class="card-title" style="color:var(--blue)">10-Q Scorecard</span></div>';
  if (s10) {
    const cls = s10.total >= 60 ? 'positive' : s10.total < 40 ? 'negative' : 'neutral';
    html += `<div class="score-total ${cls}">${s10.total}</div>`;
    html += renderNotes(s10.notes);
    html += renderDiagnostics(s10.diagnostics);
  } else {
    html += '<div class="empty">N/A — No 10-Q analyzed</div>';
  }
  html += '</div></div>';

  // ── Raw JSON ──
  html += '<div class="card mt-1"><div class="card-header"><span class="card-title">Raw Extracted JSON</span></div>';
  html += '<div class="score-grid">';
  html += '<div><div style="font-size:.75rem;color:var(--amber);font-weight:600;margin-bottom:.3rem">8-K JSON</div>';
  html += `<textarea rows="16" readonly>${r.eight_k ? JSON.stringify(r.eight_k.json, null, 2) : 'N/A'}</textarea></div>`;
  html += '<div><div style="font-size:.75rem;color:var(--blue);font-weight:600;margin-bottom:.3rem">10-Q JSON</div>';
  html += `<textarea rows="16" readonly>${r.ten_q ? JSON.stringify(r.ten_q.json, null, 2) : 'N/A'}</textarea></div>`;
  html += '</div></div>';

  $('analyze-results').innerHTML = html;
}

function buildTruthTable(s8, s10) {
  const rows = [
    {sno:'1', label:'Base Score', key:'base', section:false},
    {sno:'2', label:'Alpha Scores (Bonuses)', section:true},
    {sno:'2(a)', label:'Snowflake Rule', key:'snowflake'},
    {sno:'2(b)', label:'Amazon Exception', key:'amazon'},
    {sno:'2(c)', label:'Margin Rocket', key:'margin_rocket'},
    {sno:'3', label:'Penalties', section:true},
    {sno:'3(a)', label:'Oracle Rule', key:'oracle'},
    {sno:'3(b)', label:'Target Rule', key:'target'},
    {sno:'3(c)', label:'Zombie Check', key:'zombie'},
    {sno:'3(d)', label:'SBC "Death Ratio"', key:'sbc_death_ratio'},
    {sno:'3(e)', label:'Channel Stuffing', key:'channel_stuffing'},
    {sno:'3(f)', label:'Quality Trap', key:'quality_trap'},
    {sno:'4', label:'Waivers', section:true},
    {sno:'4(a)', label:'Gain Waiver', key:'gain_waiver'},
    {sno:'4(b)', label:'"Kitchen Sink" Bonus', key:'kitchen_sink'},
    {sno:'', label:'TOTAL', key:'_total', total:true},
  ];

  function getVal(sc, key) {
    if (!sc) return null;
    if (key === '_total') return sc.total;
    return sc.points?.[key] ?? null;
  }

  let html = '<div class="tbl-wrap"><table class="truth-table"><thead><tr>';
  html += '<th style="width:60px">S. No</th><th>Particulars</th><th style="width:80px">8-K</th><th style="width:80px">10-Q</th><th style="width:120px">Δ (10Q − 8K)</th>';
  html += '</tr></thead><tbody>';

  for (const row of rows) {
    if (row.section) {
      html += `<tr class="section-header"><td>${row.sno}</td><td colspan="4">${row.label}</td></tr>`;
      continue;
    }
    const v8 = getVal(s8, row.key);
    const v10 = getVal(s10, row.key);
    const delta = (v8 !== null && v10 !== null) ? v10 - v8 : null;
    const cls = row.total ? ' class="total-row"' : '';
    html += `<tr${cls}>
      <td>${row.sno}</td>
      <td style="font-weight:${row.total?700:400}">${row.label}</td>
      <td>${fmtVal(v8)}</td>
      <td>${fmtVal(v10)}</td>
      <td>${fmtVal(delta)}</td>
    </tr>`;
  }

  html += '</tbody></table></div>';
  return html;
}

function renderNotes(notes) {
  if (!notes || !notes.length) return '<div style="color:var(--tx3);font-size:.75rem;padding:.5rem">No triggered rules.</div>';
  let html = '<div style="margin-top:.5rem">';
  for (const n of notes) {
    let cls = 'adjust';
    if (n.startsWith('PASS')) cls = 'pass';
    else if (n.startsWith('FAIL')) cls = 'fail';
    html += `<div class="note ${cls}">${n}</div>`;
  }
  html += '</div>';
  return html;
}

function renderDiagnostics(diag) {
  if (!diag) return '';
  const items = [
    {label: 'Rev Growth', val: diag.rev_growth, fmt: fmtPct},
    {label: 'RPO Growth', val: diag.rpo_growth, fmt: fmtPct},
    {label: 'AR Growth', val: diag.ar_growth, fmt: fmtPct},
    {label: 'GM Δ (bps)', val: diag.gm_bps_change, fmt: fmtBps},
    {label: 'FCF Proxy', val: diag.fcf_proxy, fmt: v => v?.toLocaleString() ?? 'N/A'},
    {label: 'OCF/NI', val: diag.ocf_net_income_ratio, fmt: v => v?.toFixed(2) ?? 'N/A'},
    {label: 'Int/OpInc', val: diag.interest_op_income_ratio, fmt: v => v?.toFixed(2) ?? 'N/A'},
    {label: 'SBC/OCF', val: diag.sbc_ocf_ratio, fmt: v => v?.toFixed(2) ?? 'N/A'},
  ];
  let html = '<div class="diag-grid" style="margin-top:.75rem">';
  for (const it of items) {
    const display = it.val !== null && it.val !== undefined ? it.fmt(it.val) : 'N/A';
    html += `<div class="diag-item"><div class="diag-label">${it.label}</div><div class="diag-value">${display}</div></div>`;
  }
  html += '</div>';
  return html;
}
</script>
</body>
</html>
